#!/bin/bash

# set -x
set -e

HOMEBREW_PREFIX="$(brew config | grep HOMEBREW_PREFIX | awk '{print $2}')"
# fix for Intel chips and Arm chips
HOMEBREW_LIBRARY="${HOMEBREW_PREFIX}/Library"
if [ $HOMEBREW_PREFIX == '/usr/local' ]; then
  HOMEBREW_LIBRARY="${HOMEBREW_PREFIX}/Homebrew/Library"
fi

check_command_installed() {
  NAME=$1
  BREW_NAME=$2
  if ! [ -x "$(command -v $NAME)" ]; then
    echo "Error: Required GNU $NAME, try \`brew install $BREW_NAME\`"
    exit 1
  fi
}

get_version_by_info() {
  local __cask=$1
  local __info=$(brew info --cask $__cask)
  local __latest=$(echo $__info | head -n 1 | gsed 's/^==>//g' | awk '{print $2}')
  echo $__latest
}

get_versions_by_cat() {
  local __cask=$1
  local __latest=$(cat $HOMEBREW_LIBRARY/Taps/*/*/Casks/$__cask.rb | ggrep -Po 'version "\K[^"]+' | sort -r --version-sort)
  echo $__latest
}

if [ $(uname) = 'Darwin' ]; then
  check_command_installed ggrep grep
fi

for CASK in $(ls $HOMEBREW_PREFIX/Caskroom); do
  if [ ! -f $HOMEBREW_LIBRARY/Taps/*/*/Casks/$CASK.rb ]; then
    echo [Warning] Cannot find $CASK, maybe this cask is not in casks!
    continue
  fi
  LATEST="$(get_versions_by_cat $CASK)"
  lines="$(echo "$LATEST" | gsed "s/ /\n/g" | wc -l | awk '{print $1}')"
  # echo $lines
  if [ "$lines" -gt 1 ]; then
    # echo ">>> Multi $CASK"
    LATEST="$(get_version_by_info $CASK)"
  fi
  # echo ">>>> $LATEST"

  if [ ! -d "$HOMEBREW_PREFIX/Caskroom/$CASK/$LATEST" ]; then
    echo "$CASK latest: $LATEST, nothing in $HOMEBREW_PREFIX/Caskroom/$CASK/$LATEST"
  fi
done
